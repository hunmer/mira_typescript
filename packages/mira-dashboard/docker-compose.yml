version: '3.8'

services:
  # Mira Dashboard (前端)
  mira-dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mira-dashboard
    ports:
      - "3000:80"
    environment:
      - API_BASE_URL=http://mira-app-server:3999
      - SERVER_NAME=localhost
    depends_on:
      - mira-app-server
    networks:
      - mira-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.mira.local`)"
      - "traefik.http.services.dashboard.loadbalancer.server.port=80"

  # Mira Server (后端)
  mira-app-server:
    build:
      context: ../mira-app-server
      dockerfile: Dockerfile
    container_name: mira-app-server
    ports:
      - "3999:3999"
    environment:
      - NODE_ENV=production
      - PORT=3999
      - DATABASE_URL=sqlite:///app/data/library_data.db
    volumes:
      - mira-data:/app/data
      - mira-plugins:/app/plugins
    networks:
      - mira-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.mira.local`)"
      - "traefik.http.services.api.loadbalancer.server.port=3999"

networks:
  mira-network:
    driver: bridge

volumes:
  mira-data:
    driver: local
  mira-plugins:
    driver: local
