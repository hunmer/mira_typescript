{
  "nodes": [
    {
      "parameters": {
        "jsCode": "const tz = 'Asia/Shanghai';\nfunction pad(n){return n<10?('0'+n):(''+n)}\n// ä»¥ä¸Šæµ·æ—¶åŒºè®¡ç®—â€œä»Šå¤©â€\nconst nowTz = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\nconst y = nowTz.getFullYear();\nconst m = pad(nowTz.getMonth()+1);\nconst d = pad(nowTz.getDate());\nconst startMs = Date.parse(`${y}-${m}-${d}T00:00:00+08:00`);\nconst endMs   = startMs + 24*60*60*1000; // [start, end)\nreturn $input.all().map(item => {\n  const {libraryId, data} = item.json.item\n  // è¯»å–å…¨å±€é™æ€æ•°æ®é‡Œçš„ lastVideoIdï¼ˆè‹¥é¦–æ¬¡åˆ™ä¸º nullï¼‰\nconst lastId = data.lastVideoId ?? null;\n\n// æž„é€  SQLï¼ˆç¤ºä¾‹ï¼šè¡¨å assetsï¼›è‹¥ä½ çš„å®žé™…è¡¨åä¸åŒï¼Œè¯·æ”¹è¿™é‡Œï¼‰\nlet sql = `SELECT id,name,created_at,folder_id,custom_fields FROM files WHERE created_at >= ${startMs} AND created_at < ${endMs}`;\nif (lastId) sql += ` AND id > ${lastId}`;\nsql += ' ORDER BY id ASC;';\n\nreturn  {json: { startMs, endMs, lastId, libraryId, libraryData: data, sql, dateStr: `${y}-${m}-${d}` }};\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        176
      ],
      "id": "68ea48ac-a3ad-4318-ac97-2ae502fb8cef",
      "name": "Init Today + lastId"
    },
    {
      "parameters": {
        "libraryId": "={{ $json.libraryId }}",
        "sql": "={{ $json.sql }}"
      },
      "type": "n8n-nodes-mira-apis.miraLibraryQuery",
      "typeVersion": 1,
      "position": [
        1536,
        176
      ],
      "id": "03e6ec18-4667-4025-9c25-6d65ff10a9db",
      "name": "Mira: Query Today Videos",
      "credentials": {
        "MiraApiCredential": {
          "id": "UyLrgotK8r2ghdST",
          "name": "Mira account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è¾“å…¥ï¼šMira: Query Today Videos çš„è¿”å›ž { success: true, data: [...] }\nconst json_data = $('Read File').item.json.content;\nreturn $input.all().map(item => {\nconst rows = Array.isArray(item.json.data) ? item.json.data : [];\nconst agg = {};                // key: folderKeyï¼ˆæ•°å­—IDæˆ–\"__UNCLASSIFIED__\"ï¼‰ => { count, uploaders: {name:cnt} }\nconst folderIdSet = new Set(); // ä»…æ”¶é›†æœ‰æ•ˆçš„æ•°å­— folder_id\nlet maxId = null;\n\nfunction parseUploader(cf) {\n  try {\n    if (!cf) return 'æœªçŸ¥';\n    const obj = typeof cf === 'string' ? JSON.parse(cf) : cf;\n    return obj && obj.uploader ? String(obj.uploader) : 'æœªçŸ¥';\n  } catch {\n    return 'æœªçŸ¥';\n  }\n}\n\nfor (const v of rows) {\n  const fidRaw = v.folder_id;\n  const hasNumericFolder = Number.isFinite(Number(fidRaw)) && fidRaw !== null;\n\n  const folderKey = hasNumericFolder ? String(Number(fidRaw)) : '__UNCLASSIFIED__';\n  if (!agg[folderKey]) agg[folderKey] = { count: 0, uploaders: {} };\n\n  agg[folderKey].count += 1;\n\n  const uploader = parseUploader(v.custom_fields);\n  agg[folderKey].uploaders[uploader] = (agg[folderKey].uploaders[uploader] || 0) + 1;\n\n  if (typeof v.id === 'number') {\n    maxId = (maxId === null ? v.id : Math.max(maxId, v.id));\n    json_data[$('Init Today + lastId').item.json.libraryId].lastVideoId = maxId;\n  }\n\n  // ä»…å½“æ˜¯æœ‰æ•ˆçš„æ•°å­— folder_id æ—¶ï¼ŒåŠ å…¥ folderIds\n  if (hasNumericFolder) folderIdSet.add(Number(fidRaw));\n}\n\n// è¾“å‡º\nreturn {item: {\n  libraryId: $('Init Today + lastId').first().json.libraryId,\n  total: rows.length,\n  agg,                                // å¸¦æœ‰ \"__UNCLASSIFIED__\" çš„åˆ†ç»„\n  folderIds: Array.from(folderIdSet), // ä¸å« null/æ— æ•ˆ\n  maxId,\n  json_data\n}};\n  \n});\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        176
      ],
      "id": "3874e061-5221-4a19-8ff0-d43284491854",
      "name": "Aggregate by folder_id"
    },
    {
      "parameters": {
        "libraryId": "={{ $json.item.libraryId }}",
        "sql": "={{ $json.item.folderIds && $json.item.folderIds.length\n    ? `SELECT id,title FROM folders WHERE id IN (${ $json.item.folderIds.join(',') });`\n    : 'SELECT id,title FROM folders WHERE 1=0;' }}\n"
      },
      "type": "n8n-nodes-mira-apis.miraLibraryQuery",
      "typeVersion": 1,
      "position": [
        1984,
        272
      ],
      "id": "c66f706f-43ad-461d-97f8-338390c11a4c",
      "name": "Mira: Query Folder Titles",
      "credentials": {
        "MiraApiCredential": {
          "id": "UyLrgotK8r2ghdST",
          "name": "Mira account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è¯»å–ä¸¤ä¸ªä¸Šæ¸¸ï¼šèšåˆç»“æžœ + æ–‡ä»¶å¤¹æ ‡é¢˜\nconst aggItem  = $('Aggregate by folder_id').first().json.item\nconst folderRes =$input.first().json\n\nconst total = Number(aggItem.total || 0);\nconst agg   = aggItem.agg || {};\n\n// id => title\nconst titleMap = new Map();\ntry {\n  const list = Array.isArray(folderRes.data) ? folderRes.data : [];\n  for (const f of list) {\n    titleMap.set(Number(f.id), f.title || `Folder ${f.id}`);\n  }\n} catch {}\n\n// æ—¥æœŸï¼ˆä¸Šæµ·æ—¶åŒºï¼‰\nconst tz = 'Asia/Shanghai';\nconst nowTz = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\nconst y = nowTz.getFullYear();\nconst m = String(nowTz.getMonth() + 1).padStart(2, '0');\nconst d = String(nowTz.getDate()).padStart(2, '0');\nconst dateStr = `${y}-${m}-${d}`;\n\n// ä¸Šä¼ è€…æ¸²æŸ“ï¼ˆå¸¦è®¡æ•°ï¼‰\nfunction renderUploaders(uploaders = {}) {\n  const pairs = Object.entries(uploaders);\n  if (!pairs.length) return '`åŒ¿å`';\n  return pairs\n    .map(([u, c]) => (c > 1 ? `\\`${u}Ã—${c}\\`` : `\\`${u}\\``))\n    .join('ã€');\n}\n\n// è¡Œæ¸²æŸ“\nfunction renderLine(folderKey, info) {\n  const isUnclassified = folderKey === '__UNCLASSIFIED__';\n  const folderTitle = isUnclassified\n    ? 'æœªåˆ†ç±»'\n    : (titleMap.get(Number(folderKey)) || `æ–‡ä»¶å¤¹ ${folderKey}`);\n\n  return `- **${info.count}** Ã— **${folderTitle}**  Â· ä¸Šä¼ è€…ï¼š${renderUploaders(info.uploaders)}`;\n}\n\n// åˆ†ç»„æŽ’åºï¼šæŒ‰æ•°é‡é™åºï¼›åŒæ•°æ—¶â€œæœ‰æ ‡é¢˜â€ä¼˜å…ˆï¼Œâ€œæœªåˆ†ç±»â€æœ€åŽ\nconst sortedEntries = Object.entries(agg).sort(([ka, ia], [kb, ib]) => {\n  if (ia.count !== ib.count) return ib.count - ia.count;\n  if (ka === '__UNCLASSIFIED__') return 1;\n  if (kb === '__UNCLASSIFIED__') return -1;\n  return 0;\n});\n\n// æž„é€  Markdown\nlet mdTitle = `ðŸŽ¬ ç´ æä¸Šæ–°æ’­æŠ¥ Â· ${dateStr}`;\nlet mdText = '';\n\nif (total === 0) {\n  // æ— æ–°å¢žï¼šå¦‚éœ€â€œç©ºæ—¶ä¸å‘â€ï¼Œå¯è®©ä¸‹æ¸¸æ ¹æ® send=false åˆ¤æ–­\n  mdText = [\n    `> ðŸ—“ï¸ **${dateStr}**`,\n    '',\n    'ä»Šå¤©æ²¡æœ‰æ–°çš„è§†é¢‘ç´ æä¸Šæ–°ï½ž (ï¿£â–½ï¿£)ï¾‰',\n  ].join('\\n');\n} else {\n  const folderCount = sortedEntries.length;\n  const lines = sortedEntries.map(([k, info]) => renderLine(k, info));\n\n  mdText = [\n    `> ðŸ—“ï¸ **${dateStr}**`,\n    '',\n    `**ã€${$('Init Today + lastId').first().json.libraryData.title}ã€‘æ€»è§ˆ**`,\n    `- æ–°å¢žè§†é¢‘ç´ æï¼š**${total}**`,\n    `- æ¶‰åŠæ–‡ä»¶å¤¹ï¼š**${folderCount}**`,\n    '',\n    `**åˆ†ç»„æ˜Žç»†**`,\n    ...lines,\n    '',\n    'âœ¨ åŽ»çœ‹çœ‹å§~'\n  ].join('\\n');\n}\n\n// è¿”å›ž markdown + å…¼å®¹æ—§ text å­—æ®µ\nreturn [{\n  md: { title: mdTitle, text: mdText },\n  message: mdText,    // å…¼å®¹ï¼šå¦‚æžœä½ è¿˜åœ¨ç”¨ text ç±»åž‹\n  send: total > 0     // ä¸‹æ¸¸å¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦å‘é€\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        272
      ],
      "id": "80e56ad6-0a6b-4e6a-9514-e4683349c1c3",
      "name": "Build DingTalk Message"
    },
    {
      "parameters": {
        "msgtype": "markdown",
        "title": "={{ $json.md.title }}",
        "markdownText": "={{ $json.md.text }}"
      },
      "type": "n8n-nodes-dingtalk.dingTalkRobot",
      "typeVersion": 1,
      "position": [
        2656,
        272
      ],
      "id": "c2b3f369-6fc7-4d27-ac91-1eadfe609478",
      "name": "é’‰é’‰æœºå™¨äºº",
      "credentials": {
        "dingTalkCustomRobotApi": {
          "id": "LsF3CvanANpEUXSY",
          "name": "è¿è¥ç¾¤"
        }
      }
    },
    {
      "parameters": {
        "filePath": "/volume1/services/n8n/mira_library_report.json",
        "readMode": "json",
        "additionalOptions": {}
      },
      "type": "n8n-nodes-fs.readFile",
      "typeVersion": 1,
      "position": [
        864,
        176
      ],
      "id": "970c4940-5c1b-4a92-b52e-0339f3511cad",
      "name": "Read File"
    },
    {
      "parameters": {
        "filePath": "={{ $('Read File').item.json.filePath }}",
        "contentSource": "json",
        "jsonContent": "={{ $json.item.json_data }}",
        "additionalOptions": {}
      },
      "type": "n8n-nodes-fs.writeFile",
      "typeVersion": 1,
      "position": [
        1984,
        80
      ],
      "id": "7c7cfd5b-0598-4b79-9060-55d99c710b0f",
      "name": "Write File"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a8e13735-a070-4897-aae9-70a7cf3f1663",
              "leftValue": "={{ $json.send }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2432,
        272
      ],
      "id": "95836aef-1189-4640-98c2-59e0550ebe6e",
      "name": "If"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        640,
        176
      ],
      "id": "3c861049-ca62-44d3-9223-e61b8e680ba7",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "jsCode": "\nreturn Object.entries($input.first().json.content).map(([libraryId, data]) => {\n  return {\n    item: {libraryId, data}\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        176
      ],
      "id": "ea2b56f4-7be3-4325-82d2-38f6922c1bf0",
      "name": "Code"
    }
  ],
  "connections": {
    "Init Today + lastId": {
      "main": [
        [
          {
            "node": "Mira: Query Today Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mira: Query Today Videos": {
      "main": [
        [
          {
            "node": "Aggregate by folder_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate by folder_id": {
      "main": [
        [
          {
            "node": "Mira: Query Folder Titles",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mira: Query Folder Titles": {
      "main": [
        [
          {
            "node": "Build DingTalk Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build DingTalk Message": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é’‰é’‰æœºå™¨äºº": {
      "main": [
        []
      ]
    },
    "Read File": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "é’‰é’‰æœºå™¨äºº",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Read File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Init Today + lastId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d4ffe8e9ee0b48eba716706123a7187f32eae3bdcb0e7763e41e533267bd8a53"
  }
}