{
  "nodes": [
    {
      "parameters": {
        "jsCode": "const tz = 'Asia/Shanghai';\nfunction pad(n){return n<10?('0'+n):(''+n)}\n// ‰ª•‰∏äÊµ∑Êó∂Âå∫ËÆ°ÁÆó‚Äú‰ªäÂ§©‚Äù\nconst nowTz = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\nconst y = nowTz.getFullYear();\nconst m = pad(nowTz.getMonth()+1);\nconst d = pad(nowTz.getDate());\nconst startMs = Date.parse(`${y}-${m}-${d}T00:00:00+08:00`);\nconst endMs   = startMs + 24*60*60*1000; // [start, end)\nreturn $input.all().map(item => {\n  const {libraryId, data} = item.json.item\n  // ËØªÂèñÂÖ®Â±ÄÈùôÊÄÅÊï∞ÊçÆÈáåÁöÑ lastVideoIdÔºàËã•È¶ñÊ¨°Âàô‰∏∫ nullÔºâ\nconst lastId = data.lastVideoId ?? null;\n\n// ÊûÑÈÄ† SQLÔºàÁ§∫‰æãÔºöË°®Âêç assetsÔºõËã•‰Ω†ÁöÑÂÆûÈôÖË°®Âêç‰∏çÂêåÔºåËØ∑ÊîπËøôÈáåÔºâ\nlet sql = `SELECT id,name,created_at,folder_id,custom_fields FROM files WHERE created_at >= ${startMs} AND created_at < ${endMs}`;\nif (lastId) sql += ` AND id > ${lastId}`;\nsql += ' ORDER BY id ASC;';\n\nreturn  {json: { startMs, endMs, lastId, libraryId, libraryData: data, sql, dateStr: `${y}-${m}-${d}` }};\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        176
      ],
      "id": "68ea48ac-a3ad-4318-ac97-2ae502fb8cef",
      "name": "Init Today + lastId"
    },
    {
      "parameters": {
        "libraryId": "={{ $json.libraryId }}",
        "sql": "={{ $json.sql }}"
      },
      "type": "n8n-nodes-mira-apis.miraLibraryQuery",
      "typeVersion": 1,
      "position": [
        1536,
        176
      ],
      "id": "03e6ec18-4667-4025-9c25-6d65ff10a9db",
      "name": "Mira: Query Today Videos",
      "credentials": {
        "MiraApiCredential": {
          "id": "UyLrgotK8r2ghdST",
          "name": "Mira account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ËæìÂÖ•ÔºöMira: Query Today Videos ÁöÑËøîÂõû { success: true, data: [...] }\nconst json_data = $('Read File').item.json.content;\nreturn $input.all().map(item => {\nconst rows = Array.isArray(item.json.data) ? item.json.data : [];\nconst agg = {};                // key: folderKeyÔºàÊï∞Â≠óIDÊàñ\"__UNCLASSIFIED__\"Ôºâ => { count, uploaders: {name:cnt} }\nconst folderIdSet = new Set(); // ‰ªÖÊî∂ÈõÜÊúâÊïàÁöÑÊï∞Â≠ó folder_id\nlet maxId = null;\n\nfunction parseUploader(cf) {\n  try {\n    if (!cf) return 'Êú™Áü•';\n    const obj = typeof cf === 'string' ? JSON.parse(cf) : cf;\n    return obj && obj.uploader ? String(obj.uploader) : 'Êú™Áü•';\n  } catch {\n    return 'Êú™Áü•';\n  }\n}\n\nfor (const v of rows) {\n  const fidRaw = v.folder_id;\n  const hasNumericFolder = Number.isFinite(Number(fidRaw)) && fidRaw !== null;\n\n  const folderKey = hasNumericFolder ? String(Number(fidRaw)) : '__UNCLASSIFIED__';\n  if (!agg[folderKey]) agg[folderKey] = { count: 0, uploaders: {} };\n\n  agg[folderKey].count += 1;\n\n  const uploader = parseUploader(v.custom_fields);\n  agg[folderKey].uploaders[uploader] = (agg[folderKey].uploaders[uploader] || 0) + 1;\n\n  if (typeof v.id === 'number') {\n    maxId = (maxId === null ? v.id : Math.max(maxId, v.id));\n    json_data[$('Init Today + lastId').item.json.libraryId].lastVideoId = maxId;\n  }\n\n  // ‰ªÖÂΩìÊòØÊúâÊïàÁöÑÊï∞Â≠ó folder_id Êó∂ÔºåÂä†ÂÖ• folderIds\n  if (hasNumericFolder) folderIdSet.add(Number(fidRaw));\n}\n\n// ËæìÂá∫\nreturn {item: {\n  libraryId: $('Init Today + lastId').first().json.libraryId,\n  total: rows.length,\n  agg,                                // Â∏¶Êúâ \"__UNCLASSIFIED__\" ÁöÑÂàÜÁªÑ\n  folderIds: Array.from(folderIdSet), // ‰∏çÂê´ null/Êó†Êïà\n  maxId,\n  json_data\n}};\n  \n});\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        176
      ],
      "id": "3874e061-5221-4a19-8ff0-d43284491854",
      "name": "Aggregate by folder_id"
    },
    {
      "parameters": {
        "libraryId": "={{ $json.item.libraryId }}",
        "sql": "={{ $json.item.folderIds && $json.item.folderIds.length\n    ? `SELECT id,title FROM folders WHERE id IN (${ $json.item.folderIds.join(',') });`\n    : 'SELECT id,title FROM folders WHERE 1=0;' }}\n"
      },
      "type": "n8n-nodes-mira-apis.miraLibraryQuery",
      "typeVersion": 1,
      "position": [
        1984,
        272
      ],
      "id": "c66f706f-43ad-461d-97f8-338390c11a4c",
      "name": "Mira: Query Folder Titles",
      "credentials": {
        "MiraApiCredential": {
          "id": "UyLrgotK8r2ghdST",
          "name": "Mira account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ËØªÂèñ‰∏§‰∏™‰∏äÊ∏∏ÔºöËÅöÂêàÁªìÊûú + Êñá‰ª∂Â§πÊ†áÈ¢ò\nconst aggItem  = $('Aggregate by folder_id').first().json.item\nconst folderRes =$input.first().json\n\nconst total = Number(aggItem.total || 0);\nconst agg   = aggItem.agg || {};\n\n// id => title\nconst titleMap = new Map();\ntry {\n  const list = Array.isArray(folderRes.data) ? folderRes.data : [];\n  for (const f of list) {\n    titleMap.set(Number(f.id), f.title || `Folder ${f.id}`);\n  }\n} catch {}\n\n// Êó•ÊúüÔºà‰∏äÊµ∑Êó∂Âå∫Ôºâ\nconst tz = 'Asia/Shanghai';\nconst nowTz = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\nconst y = nowTz.getFullYear();\nconst m = String(nowTz.getMonth() + 1).padStart(2, '0');\nconst d = String(nowTz.getDate()).padStart(2, '0');\nconst dateStr = `${y}-${m}-${d}`;\n\n// ‰∏ä‰º†ËÄÖÊ∏≤ÊüìÔºàÂ∏¶ËÆ°Êï∞Ôºâ\nfunction renderUploaders(uploaders = {}) {\n  const pairs = Object.entries(uploaders);\n  if (!pairs.length) return '`ÂåøÂêç`';\n  return pairs\n    .map(([u, c]) => (c > 1 ? `\\`${u}√ó${c}\\`` : `\\`${u}\\``))\n    .join('„ÄÅ');\n}\n\n// Ë°åÊ∏≤Êüì\nfunction renderLine(folderKey, info) {\n  const isUnclassified = folderKey === '__UNCLASSIFIED__';\n  const folderTitle = isUnclassified\n    ? 'Êú™ÂàÜÁ±ª'\n    : (titleMap.get(Number(folderKey)) || `Êñá‰ª∂Â§π ${folderKey}`);\n\n  return `- **${info.count}** √ó **${folderTitle}**  ¬∑ ‰∏ä‰º†ËÄÖÔºö${renderUploaders(info.uploaders)}`;\n}\n\n// ÂàÜÁªÑÊéíÂ∫èÔºöÊåâÊï∞ÈáèÈôçÂ∫èÔºõÂêåÊï∞Êó∂‚ÄúÊúâÊ†áÈ¢ò‚Äù‰ºòÂÖàÔºå‚ÄúÊú™ÂàÜÁ±ª‚ÄùÊúÄÂêé\nconst sortedEntries = Object.entries(agg).sort(([ka, ia], [kb, ib]) => {\n  if (ia.count !== ib.count) return ib.count - ia.count;\n  if (ka === '__UNCLASSIFIED__') return 1;\n  if (kb === '__UNCLASSIFIED__') return -1;\n  return 0;\n});\n\n// ÊûÑÈÄ† Markdown\nlet mdTitle = `üé¨ Á¥†Êùê‰∏äÊñ∞Êí≠Êä• ¬∑ ${dateStr}`;\nlet mdText = '';\n\nif (total === 0) {\n  // Êó†Êñ∞Â¢ûÔºöÂ¶ÇÈúÄ‚ÄúÁ©∫Êó∂‰∏çÂèë‚ÄùÔºåÂèØËÆ©‰∏ãÊ∏∏Ê†πÊçÆ send=false Âà§Êñ≠\n  mdText = [\n    `> üóìÔ∏è **${dateStr}**`,\n    '',\n    '‰ªäÂ§©Ê≤°ÊúâÊñ∞ÁöÑËßÜÈ¢ëÁ¥†Êùê‰∏äÊñ∞ÔΩû (Ôø£‚ñΩÔø£)Ôæâ',\n  ].join('\\n');\n} else {\n  const folderCount = sortedEntries.length;\n  const lines = sortedEntries.map(([k, info]) => renderLine(k, info));\n\n  mdText = [\n    `> üóìÔ∏è **${dateStr}**`,\n    '',\n    `**„Äê${$('Init Today + lastId').first().json.libraryData.title}„ÄëÊÄªËßà**`,\n    `- Êñ∞Â¢ûËßÜÈ¢ëÁ¥†ÊùêÔºö**${total}**`,\n    `- Ê∂âÂèäÊñá‰ª∂Â§πÔºö**${folderCount}**`,\n    '',\n    `**ÂàÜÁªÑÊòéÁªÜ**`,\n    ...lines,\n    '',\n    '‚ú® ÂéªÁúãÁúãÂêß~'\n  ].join('\\n');\n}\n\n// ËøîÂõû markdown + ÂÖºÂÆπÊóß text Â≠óÊÆµ\nreturn [{\n  md: { title: mdTitle, text: mdText },\n  message: mdText,    // ÂÖºÂÆπÔºöÂ¶ÇÊûú‰Ω†ËøòÂú®Áî® text Á±ªÂûã\n  send: total > 0     // ‰∏ãÊ∏∏ÂèØÁî®Êù•Âà§Êñ≠ÊòØÂê¶ÂèëÈÄÅ\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        272
      ],
      "id": "80e56ad6-0a6b-4e6a-9514-e4683349c1c3",
      "name": "Build DingTalk Message"
    },
    {
      "parameters": {
        "msgtype": "markdown",
        "title": "={{ $json.md.title }}",
        "markdownText": "={{ $json.md.text }}"
      },
      "type": "n8n-nodes-dingtalk.dingTalkRobot",
      "typeVersion": 1,
      "position": [
        2656,
        272
      ],
      "id": "c2b3f369-6fc7-4d27-ac91-1eadfe609478",
      "name": "ÈíâÈíâÊú∫Âô®‰∫∫",
      "credentials": {
        "dingTalkCustomRobotApi": {
          "id": "LsF3CvanANpEUXSY",
          "name": "ËøêËê•Áæ§"
        }
      }
    },
    {
      "parameters": {
        "filePath": "/volume1/services/n8n/mira_library_report.json",
        "readMode": "json",
        "additionalOptions": {}
      },
      "type": "n8n-nodes-fs.readFile",
      "typeVersion": 1,
      "position": [
        864,
        176
      ],
      "id": "970c4940-5c1b-4a92-b52e-0339f3511cad",
      "name": "Read File"
    },
    {
      "parameters": {
        "filePath": "={{ $('Read File').item.json.filePath }}",
        "contentSource": "json",
        "jsonContent": "={{ $json.item.json_data }}",
        "additionalOptions": {}
      },
      "type": "n8n-nodes-fs.writeFile",
      "typeVersion": 1,
      "position": [
        1984,
        80
      ],
      "id": "7c7cfd5b-0598-4b79-9060-55d99c710b0f",
      "name": "Write File"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a8e13735-a070-4897-aae9-70a7cf3f1663",
              "leftValue": "={{ $json.send }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2432,
        272
      ],
      "id": "95836aef-1189-4640-98c2-59e0550ebe6e",
      "name": "If"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        640,
        176
      ],
      "id": "3c861049-ca62-44d3-9223-e61b8e680ba7",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "jsCode": "\nreturn Object.entries($input.first().json.content).map(([libraryId, data]) => {\n  return {\n    item: {libraryId, data}\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        176
      ],
      "id": "ea2b56f4-7be3-4325-82d2-38f6922c1bf0",
      "name": "Code"
    }
  ],
  "connections": {
    "Init Today + lastId": {
      "main": [
        [
          {
            "node": "Mira: Query Today Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mira: Query Today Videos": {
      "main": [
        [
          {
            "node": "Aggregate by folder_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate by folder_id": {
      "main": [
        [
          {
            "node": "Mira: Query Folder Titles",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mira: Query Folder Titles": {
      "main": [
        [
          {
            "node": "Build DingTalk Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build DingTalk Message": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÈíâÈíâÊú∫Âô®‰∫∫": {
      "main": [
        []
      ]
    },
    "Read File": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "ÈíâÈíâÊú∫Âô®‰∫∫",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Read File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Init Today + lastId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d4ffe8e9ee0b48eba716706123a7187f32eae3bdcb0e7763e41e533267bd8a53"
  }
}