# Mira 定时公告工作流使用指南

## 概述

本工作流基于 Mira 上传统计插件（`upload_statistics`）的逻辑，实现了定时发送素材上传统计报告到钉钉群的功能。

## 工作流文件

### 1. `dingtalk_upload_statistics_workflow.json`
- **功能**: 基础版本，每天定时发送上传统计报告
- **特点**: 简单易用，适合基本需求

### 2. `advanced_dingtalk_statistics_workflow.json`
- **功能**: 高级版本，支持条件判断和灵活配置
- **特点**: 功能丰富，支持多种触发条件

## 核心功能

### 📊 统计报告内容
- **排行榜**: 按上传数量排序的用户排行
- **文件统计**: 总文件数量和大小
- **用户统计**: 参与上传的用户总数
- **时间范围**: 可配置的统计周期（默认7天）

### ⏰ 定时触发
- **每日报告**: 每天指定时间发送（默认20:00）
- **周报**: 可选择周一发送周度统计
- **条件触发**: 根据数据阈值决定是否发送

### 🔧 配置选项

#### 基本配置
```javascript
{
  "reportDaysRange": 7,        // 统计天数范围
  "maxDisplayUsers": 10,       // 最多显示用户数
  "minFilesThreshold": 1,      // 最小文件数阈值
  "reportHour": 20,            // 报告发送小时
  "reportMinute": 0            // 报告发送分钟
}
```

#### 钉钉配置
```javascript
{
  "webhook": "YOUR_DINGTALK_WEBHOOK_URL",  // 钉钉机器人Webhook
  "secret": "YOUR_DINGTALK_SECRET"         // 钉钉机器人密钥
}
```

#### Mira 配置
```javascript
{
  "libraryId": "YOUR_LIBRARY_ID",                              // 素材库ID
  "authToken": "Bearer your-mira-token-here"                   // Mira认证令牌
}
```

#### 行为配置
```javascript
{
  "enableDailyReport": true,      // 启用每日报告
  "enableWeeklyReport": true,     // 启用周报
  "onlyReportIfHasData": true     // 仅在有数据时发送
}
```

## 节点说明

### 核心节点

1. **定时触发器 (Cron Trigger)**
   - 类型: `n8n-nodes-base.cron`
   - 功能: 按设定时间触发工作流

2. **配置参数 (Set)**
   - 类型: `n8n-nodes-base.set`
   - 功能: 设置工作流配置参数

3. **获取上传统计数据 (HTTP Request)**
   - 类型: `n8n-nodes-base.httpRequest`
   - 功能: 调用 Mira API 获取统计数据

4. **处理统计数据 (Function)**
   - 类型: `n8n-nodes-base.function`
   - 功能: 处理数据并生成报告内容

5. **发送钉钉消息 (DingTalk)**
   - 类型: `n8n-nodes-dingtalk.dingtalk`
   - 功能: 发送 Markdown 格式消息到钉钉群

### 条件节点

6. **检查发送条件 (If)**
   - 功能: 判断是否满足发送条件

7. **检查数据阈值 (If)**
   - 功能: 验证数据是否达到发送阈值

## 配置步骤

### 1. 钉钉机器人配置

1. 在钉钉群中添加自定义机器人
2. 获取 Webhook URL 和安全设置中的加签密钥
3. 在工作流的"配置参数"节点中更新相应值

### 2. Mira 服务配置

1. 确保 Mira 服务运行在 `http://localhost:8081`
2. 获取有效的 API 认证令牌
3. 确认素材库ID

### 3. 时间配置

在"定时触发器"节点中设置：
- `hour`: 发送报告的小时（0-23）
- `minute`: 发送报告的分钟（0-59）

## 高级功能

### 条件发送逻辑

高级版本工作流支持以下条件：

1. **时间条件**: 每日或周度报告
2. **数据条件**: 最小文件数阈值
3. **强制条件**: 即使无数据也发送

### 数据处理逻辑

统计数据处理包括：
- 用户上传数量统计
- 文件大小统计和格式化
- 排行榜生成
- 报告格式化

### 错误处理

工作流包含多个条件分支：
- 无数据时的日志记录
- API调用失败的错误处理
- 条件不满足时的跳过逻辑

## 消息格式

### 报告内容示例

```markdown
## 📊 周度素材上传统计报告

📅 **统计周期**: 2025-08-21 ~ 2025-08-28

📁 **总计**: 45个文件，共125.6 MB

👥 **参与用户**: 8人

### 🏆 上传排行榜

🥇 **1. 张三**
   📄 15个文件 | 💾 45.2 MB

🥈 **2. 李四**
   📄 12个文件 | 💾 38.1 MB

🥉 **3. 王五**
   📄 8个文件 | 💾 22.3 MB

### 💪 继续加油！

感谢大家的积极参与，让我们的素材库更加丰富！🎉
```

## 生产环境注意事项

### 1. 性能考虑
- 统计数据量大时考虑分页处理
- 定时任务避免在业务高峰期执行

### 2. 安全配置
- 妥善保管钉钉机器人密钥
- 使用环境变量存储敏感信息
- 定期更新 API 认证令牌

### 3. 监控告警
- 监控工作流执行状态
- 设置 API 调用失败告警
- 记录关键操作日志

### 4. 扩展建议
- 支持多个钉钉群发送
- 添加图表生成功能
- 集成更多统计维度

## 故障排除

### 常见问题

1. **钉钉消息发送失败**
   - 检查 Webhook URL 和密钥
   - 验证机器人权限设置
   - 确认消息格式正确

2. **统计数据获取失败**
   - 检查 Mira 服务状态
   - 验证 API 认证令牌
   - 确认接口路径正确

3. **定时触发不工作**
   - 检查 Cron 表达式格式
   - 确认 n8n 服务运行状态
   - 验证时区设置

### 调试方法

1. 启用工作流日志记录
2. 单步执行验证每个节点
3. 检查 n8n 执行历史
4. 监控相关服务日志

## 与原插件的对应关系

本工作流复现了 `upload_statistics` 插件的核心功能：

| 插件功能 | 工作流实现 |
|---------|----------|
| `generateRankingText()` | "处理统计数据"节点 |
| `generateAndSendReport()` | "发送钉钉消息"节点 |
| 定时报告配置 | "配置参数"和"定时触发器"节点 |
| API调用 | "获取上传统计数据"节点 |
| 条件判断 | "检查发送条件"和"检查数据阈值"节点 |

这样的设计确保了工作流与原有插件逻辑的一致性，同时提供了更好的可视化和配置灵活性。
