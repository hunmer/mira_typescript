{
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "hours",
                            "hoursInterval": 24
                        },
                        {
                            "field": "minutes",
                            "minutesInterval": 0
                        }
                    ]
                }
            },
            "id": "a9a01a53-8075-4388-becf-c256e26b63bd",
            "name": "å®šæ—¶è§¦å‘å™¨",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                -1248,
                128
            ]
        },
        {
            "parameters": {
                "mode": "raw",
                "jsonOutput": "{\n  \"reportDaysRange\": 7,\n  \"maxDisplayUsers\": 10,\n  \"minFilesThreshold\": 1,\n  \"reportHour\": 20,\n  \"reportMinute\": 0,\n  \"libraryId\": \"1755239013113\",\n  \"authToken\": \"Bearer mira-token-1-1755904810547-9c70962a10fe6f67a467bbdfe8859d1c57e8c38a9d7ec66f90dc68161694a7cd\",\n  \"enableDailyReport\": true,\n  \"enableWeeklyReport\": true,\n  \"onlyReportIfHasData\": true\n}",
                "options": {
                    "dotNotation": false
                }
            },
            "id": "7024052b-2eab-4928-a070-c7d126aa6ac8",
            "name": "é…ç½®å‚æ•°",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -1024,
                128
            ]
        },
        {
            "parameters": {
                "jsCode": "// æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘é€æŠ¥å‘Š\nconst config = $input.first().json;\nconst now = new Date();\nconst dayOfWeek = now.getDay(); // 0 = å‘¨æ—¥, 1 = å‘¨ä¸€, ..., 6 = å‘¨å…­\n\n// æ£€æŸ¥æ—¶é—´æ¡ä»¶\nconst shouldSendDaily = config.enableDailyReport;\nconst shouldSendWeekly = config.enableWeeklyReport && dayOfWeek === 1; // å‘¨ä¸€å‘é€å‘¨æŠ¥\n\n// å½“å‰æ˜¯å¦åº”è¯¥å‘é€\nconst shouldSend = shouldSendDaily || shouldSendWeekly;\n\nconsole.log(`[æ£€æŸ¥å‘é€æ¡ä»¶] ä»Šæ—¥: ${dayOfWeek}, æ¯æ—¥æŠ¥å‘Š: ${shouldSendDaily}, å‘¨æŠ¥: ${shouldSendWeekly}, åº”å‘é€: ${shouldSend}`);\n\nreturn {\n    shouldSend,\n    reportType: shouldSendWeekly ? 'weekly' : 'daily',\n    dayOfWeek,\n    ...config\n};"
            },
            "id": "a68eef7c-a824-4e27-a2eb-9d7a5b0c79cb",
            "name": "æ£€æŸ¥å‘é€æ¡ä»¶",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -800,
                128
            ]
        },
        {
            "parameters": {
                "url": "http://localhost:8081/upload_statistics/list",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        {
                            "name": "startDate",
                            "value": "={{ $now.minus({days: $json.reportDaysRange}).toISODate() }}"
                        },
                        {
                            "name": "endDate",
                            "value": "={{ $now.toISODate() }}"
                        },
                        {
                            "name": "libraryId",
                            "value": "={{ $json.libraryId }}"
                        }
                    ]
                },
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "Authorization",
                            "value": "={{ $json.authToken }}"
                        }
                    ]
                },
                "options": {
                    "response": {
                        "response": {
                            "responseFormat": "json"
                        }
                    }
                }
            },
            "id": "50ebb096-3e75-49a8-8c89-e47ad5f3f0f2",
            "name": "è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                -352,
                32
            ]
        },
        {
            "parameters": {
                "jsCode": "// å¤„ç†ç»Ÿè®¡æ•°æ®ï¼Œç”Ÿæˆæ’è¡Œæ¦œ\nconst files = $input.all();\nconsole.log({files});\nconst config = $('æ£€æŸ¥å‘é€æ¡ä»¶').first().json;\nconst maxDisplayUsers = config.maxDisplayUsers;\nconst reportDaysRange = config.reportDaysRange;\nconst reportType = config.reportType;\n\nconsole.log(`[å¤„ç†ç»Ÿè®¡æ•°æ®] è·å–åˆ° ${files.length} ä¸ªæ–‡ä»¶è®°å½•`);\n\n// è®¡ç®—æ—¥æœŸèŒƒå›´\nconst endDate = new Date();\nconst startDate = new Date();\nstartDate.setDate(endDate.getDate() - reportDaysRange);\n\n// ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„ä¸Šä¼ æ•°é‡å’Œæ–‡ä»¶å¤§å°\nconst userStats = {};\nlet totalSize = 0;\n\nfiles.forEach(({json: file}) => {\n    const uploader = file.uploader || 'æœªçŸ¥ç”¨æˆ·';\n    const fileSize = file.size || 0;\n    \n    if (!userStats[uploader]) {\n        userStats[uploader] = {\n            count: 0,\n            size: 0,\n            files: []\n        };\n    }\n    \n    userStats[uploader].count += 1;\n    userStats[uploader].size += fileSize;\n    userStats[uploader].files.push({\n        name: file.name,\n        size: fileSize,\n        created_at: file.created_at\n    });\n    \n    totalSize += fileSize;\n});\n\n// æ’åºå¹¶æˆªå–å‰Nå\nconst sortedUsers = Object.entries(userStats)\n    .sort((a, b) => b[1].count - a[1].count)\n    .slice(0, maxDisplayUsers);\n\n// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°\nfunction formatSize(bytes) {\n    if (bytes === 0) return '0 B';\n    const k = 1024;\n    const sizes = ['B', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\n// ç”ŸæˆæŠ¥å‘Šæ ‡é¢˜\nconst reportTitle = reportType === 'weekly' ? 'ğŸ“Š å‘¨åº¦ç´ æä¸Šä¼ ç»Ÿè®¡æŠ¥å‘Š' : 'ğŸ“ˆ æ¯æ—¥ç´ æä¸Šä¼ ç»Ÿè®¡æŠ¥å‘Š';\n\n// ç”Ÿæˆæ’è¡Œæ¦œæ–‡æœ¬\nlet rankingText = `## ${reportTitle}\\n\\n`;\nrankingText += `ğŸ“… **ç»Ÿè®¡å‘¨æœŸ**: ${startDate.toISOString().split('T')[0]} ~ ${endDate.toISOString().split('T')[0]}\\n\\n`;\nrankingText += `ğŸ“ **æ€»è®¡**: ${files.length}ä¸ªæ–‡ä»¶ï¼Œå…±${formatSize(totalSize)}\\n\\n`;\nrankingText += `ğŸ‘¥ **å‚ä¸ç”¨æˆ·**: ${Object.keys(userStats).length}äºº\\n\\n`;\n\nif (sortedUsers.length > 0) {\n    rankingText += `### ğŸ† ä¸Šä¼ æ’è¡Œæ¦œ\\n\\n`;\n    sortedUsers.forEach(([user, stats], index) => {\n        const emoji = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ…';\n        rankingText += `${emoji} **${index + 1}. ${user}**\\n`;\n        rankingText += `   ğŸ“„ ${stats.count}ä¸ªæ–‡ä»¶ | ğŸ’¾ ${formatSize(stats.size)}\\n\\n`;\n    });\n} else {\n    rankingText += '### ğŸ“ æœ¬æœŸæš‚æ— ä¸Šä¼ è®°å½•\\n\\n';\n}\n\n// æ·»åŠ æ¿€åŠ±è¯­å¥\nif (files.length > 0) {\n    rankingText += `### ğŸ’ª ç»§ç»­åŠ æ²¹ï¼\\n\\n`;\n    rankingText += `æ„Ÿè°¢å¤§å®¶çš„ç§¯æå‚ä¸ï¼Œè®©æˆ‘ä»¬çš„ç´ æåº“æ›´åŠ ä¸°å¯Œï¼ğŸ‰\\n`;\n}\n\nconsole.log(`[å¤„ç†ç»Ÿè®¡æ•°æ®] ç”ŸæˆæŠ¥å‘Š: ${Object.keys(userStats).length} ç”¨æˆ·, ${files.length} æ–‡ä»¶`);\n\nreturn {\n    title: reportTitle,\n    text: rankingText,\n    totalFiles: files.length,\n    totalUsers: Object.keys(userStats).length,\n    totalSize: formatSize(totalSize),\n    reportType,\n    dateRange: {\n        start: startDate.toISOString().split('T')[0],\n        end: endDate.toISOString().split('T')[0]\n    },\n    config\n};"
            },
            "id": "a0a3079d-3aff-4ac3-9fa2-f578ac624d5f",
            "name": "å¤„ç†ç»Ÿè®¡æ•°æ®",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -128,
                32
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 1
                    },
                    "conditions": [
                        {
                            "id": "condition-1",
                            "leftValue": "={{ $json.totalFiles }}",
                            "rightValue": "={{ $json.config.minFilesThreshold }}",
                            "operator": {
                                "type": "number",
                                "operation": "gte"
                            }
                        },
                        {
                            "id": "condition-2",
                            "leftValue": "={{ $json.config.onlyReportIfHasData }}",
                            "rightValue": false,
                            "operator": {
                                "type": "boolean",
                                "operation": "equal"
                            }
                        }
                    ],
                    "combinator": "or"
                },
                "options": {}
            },
            "id": "d15bb513-5c74-4eb0-b661-c22786275c9a",
            "name": "æ£€æŸ¥æ•°æ®é˜ˆå€¼",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.1,
            "position": [
                96,
                32
            ]
        },
        {
            "parameters": {
                "msgtype": "actionCard",
                "title": "={{ $json.title }}",
                "markdownText": "={{ $json.text }}",
                "singleTitle": "æŸ¥çœ‹è¯¦æƒ…",
                "singleURL": "https://www.baidu.com"
            },
            "id": "e65ecd1d-4229-4a2e-8b58-164c68da07c1",
            "name": "å‘é€é’‰é’‰æ¶ˆæ¯",
            "type": "n8n-nodes-dingtalk.dingTalkRobot",
            "typeVersion": 1,
            "position": [
                320,
                -64
            ],
            "credentials": {
                "dingTalkCustomRobotApi": {
                    "id": "zdEK4xq2u8jsaYwO",
                    "name": "DingTalkCustomRobot account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// è®°å½•è·³è¿‡æ—¥å¿—\nconsole.log(`æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡å‘é€é€šçŸ¥ - æ€»æ–‡ä»¶æ•°: ${$json.totalFiles}ï¼Œé˜ˆå€¼: ${$json.config.minFilesThreshold}`);\nreturn $input.all();"
            },
            "id": "891aaa28-50c3-41c9-8713-2252b12aa83d",
            "name": "è®°å½•è·³è¿‡æ—¥å¿—",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                320,
                128
            ]
        },
        {
            "parameters": {
                "jsCode": "// è®°å½•ä¸å‘é€æ—¥å¿—\nconsole.log('ä»Šæ—¥ä¸å‘é€æŠ¥å‘Š - å½“å‰æ—¶é—´æ¡ä»¶ä¸æ»¡è¶³');\nreturn $input.all();"
            },
            "id": "28ee1d9c-9d52-46b4-a634-9f82d4c4a424",
            "name": "è®°å½•ä¸å‘é€æ—¥å¿—",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -352,
                224
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "af8d723b-62a9-44f4-b281-c9869a01c3ab",
                            "leftValue": "={{ $json.shouldSend }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        },
                        {
                            "id": "86446386-588e-429e-9ed5-2b49ac1a1f51",
                            "leftValue": "",
                            "rightValue": "",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                -576,
                128
            ],
            "id": "719f29b7-e002-4580-a475-e757d80063ab",
            "name": "If"
        }
    ],
    "connections": {
        "å®šæ—¶è§¦å‘å™¨": {
            "main": [
                [
                    {
                        "node": "é…ç½®å‚æ•°",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "é…ç½®å‚æ•°": {
            "main": [
                [
                    {
                        "node": "æ£€æŸ¥å‘é€æ¡ä»¶",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ£€æŸ¥å‘é€æ¡ä»¶": {
            "main": [
                [
                    {
                        "node": "If",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®": {
            "main": [
                [
                    {
                        "node": "å¤„ç†ç»Ÿè®¡æ•°æ®",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å¤„ç†ç»Ÿè®¡æ•°æ®": {
            "main": [
                [
                    {
                        "node": "æ£€æŸ¥æ•°æ®é˜ˆå€¼",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ£€æŸ¥æ•°æ®é˜ˆå€¼": {
            "main": [
                [
                    {
                        "node": "å‘é€é’‰é’‰æ¶ˆæ¯",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "è®°å½•è·³è¿‡æ—¥å¿—",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If": {
            "main": [
                [
                    {
                        "node": "è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "è®°å½•ä¸å‘é€æ—¥å¿—",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "instanceId": "fc7383d05e70dfb2e5bc24a56107b9dcb53bde5758f7387e737ce362de870369"
    }
}